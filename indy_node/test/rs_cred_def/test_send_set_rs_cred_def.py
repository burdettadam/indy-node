import asyncio
import json

from indy.ledger import sign_request, submit_request

from indy_common.constants import RS_META, RS_META_NAME, RS_META_VERSION, RS_DATA, RS_JSON_LD_ID, \
    RS_META_ID, RS_META_TYPE, SET_RS_CRED_DEF, RS_CRED_DEF_TAG, RS_CRED_DEF_PUBLIC_KEYS, RS_CRED_DEF_SIGNATURE_TYPE, \
    RS_CRED_DEF_MAPPING_REF, RS_CRED_DEF_SCHEMA_REF
from indy_common.state.state_constants import MARKER_RS_CRED_DEF
from plenum.test.conftest import sdk_wallet_trustee
from plenum.test.helper import sdk_check_reply, sdk_sign_and_submit_req, sdk_get_and_check_replies


def test_send_cred_def(looper, sdk_pool_handle, sdk_wallet_endorser):
    _, requests_did = sdk_wallet_endorser
    authors_did, type, name, version = requests_did, MARKER_RS_CRED_DEF, "ISO18023_Drivers_License", "1.1",
    _id = authors_did + ':' + type + ':' + name + ':' + version
    txn_json = json.dumps({
        'operation': {
            'type': SET_RS_CRED_DEF,
            RS_META: {
                RS_META_ID: _id,
                RS_META_TYPE: MARKER_RS_CRED_DEF,
                RS_META_NAME: name,
                RS_META_VERSION: version
            },
            RS_DATA: {
                RS_JSON_LD_ID: _id,
                "@context": "ctx:sov:44bBhN4mwLJQQCCS2CG9f53JsuyqLwz3MtxM9uLw",
                "@type": "sch:sov:22KpkXgecryx9k7N6XN1QoN3gXwBkSU8SfyyYQG",
                "issuer": "did:sov:Wz4eUg7SetGfaUVCn8U9d62oDYrUJLuUtcy619",
                RS_CRED_DEF_SCHEMA_REF: [
                    "sch:sov:7L6jCikco4kAdwa3yjNWrmwy19deEiWgY"
                ],
                RS_CRED_DEF_MAPPING_REF: "map:sov:2YhmsE2hNTALqKZABiHZz4X2mGUXWUCkBt8ba3Em1An",
                RS_CRED_DEF_SIGNATURE_TYPE:'cl',
                RS_CRED_DEF_PUBLIC_KEYS: {
                    "n": "0x3627B9F87F29738C4E1CA3D374C3DD2A003BA7C510DA42F564881B15459AAD56F7AB739E1358FC7FC5D0C94A86D06351DB6E44E466848E5CEB561F50587CA6A32A219BB9B91FF745395A1B9726BC0D019ED27E2E25A317BB9865FD14B446DD27447C190EF8D3D602CF1B344C30FFEB071F12B94E0C701D1C371A156E7EFEBB2528E903C65EACD914CF92235C73C15B4A33EF8F0BFFF527ACDB65E952B3C814C095D8952A558A39D87F0BE586FD7F694D5F0CFF81050F22142DE27DE2FF1156B8BA1E58DC3D849DFA6107F0EB5CF5078CC78DDFA81678AD63DC3DEC278F37C0CC90FB4AB71F4ED56F7BE21CB50195DA6896107BA3D8BDC8E00DC480EEBAB0DD26D",
                    "S": "0x1B41306A1FF037EC2744C1DC48F6E2B11D21C4BF372B27DCAB9D76EF4F303D75900B66637FE3A86462F5DE871BAB46D149C3D863E5E08BE33AD24655F15B98FC04E2C4F99789D174F7D5BE9ADCF7BBF8AAB7767A2667AFDA47E5E75FA18ABCDC55F7039AA1E958B17D75B6A806FA08249D31A929920C592724CA1E8E0B055362D6B116C3E3C54C79398A2F8EF01D181B3B35EF9CB97BD36F27EDCCB96EDE2C7490B5F5213075DC2275D2A1928E759FB0FF892A5427866BF3FB56451F2B6BA6F92FA43B07B16465799F4951DCC487B99907620045C5B39FF9C73A88BFA649484A3561C34AC1A849E9C639420027CE9E67722DA373DF5007F01A3247BF499AE33C1",
                    "Z": "0x1E9D0B9BA5CC2D8A97866D01049822F30641EC4D79F32B785F8A392AC2E98CD4CDB3FC6453BA2796F4C4AB9B79B7FA79C11B03086856D2188E585F38715E1590F3DAE6AA906C399F5138BD1E8EA99BF77592DE8409AE237E85A97CD25C87065FEFB05336C269C4A92F989F459B9B408314EA5B76D422CFC0DFCFEA27A118F4AFECA0CC0D58D330FF19BEF3591AB6E1336F1DBD4B9F188F30564ADAFB5A1E46EF7B0A8F8F348FB583746A01570D808F17AB84561EE3A29060E4EB80979B885FD05FDCB3688DC58266904295241F1AB4457EDC36F9D92EE80887BAFE8414442DEC1698583CD86E4C1C53481FFC674B977D5DEA8F96B7E73D1013BC7C8673CC3F2E6",
                    "R": {
                        "Rb1": "0x28046DA1FA1C2D7EC7767DA9BF51D2A1EB10E1CD62A44CC606DEF603837A43A0B81772519BE5969B2B6667BBB15ED2FA1BE57443501CE40C90D91F83720FD6F43DB0D5664C665FAE8D54E7590C2878B3095F953A03A42B7F19E1B565AECD19E483B3FCA256B5D31312605B7B6A38D5607259AF21624EF3CA8EE244137BFD42CDC7416D03D7195DF29C097ABCA12BA84DA741BDE16E483FDDD7B2F27D3C1612A3B8039F1E7DAC65A7A534698D74A835C035A925BDF0D431C0AE6C777DBC7A6C0D83411D70B97922E110DD561BB088B498D7A79C4D1DFCC649405D53E00857CC67D75064CED3942795F3CFF797D1DDDB65AE9B02D627CACC1EAC148EBC2BA6C7D6B",
                        "Ri1": "0x2A1A1668E8290ADEB621A487F19CFD8836C629D0F49F582FDB94B55143B11DEB892EEF5FF2744EFE24894C303B87134C217B4F760AAD990FD92006D0C13D84B5356C79AE92D5D70323F4545A471F157D1E58C1182C941594384D742AB4C138C822D440BB6FAD6C75F6D8BD7FB778462940DBC95756F9EF57BBD47701DB8520E94DA49AF7ED522510EC11911C8F3C7932BDF791F100FA9ECD30BE8306B24B4C47785E2459D6CF30759C8A3756B8D32A6B8BC1F56582BC67D6AA4BD8E957A94D47A3D76337F60753FFCBCECD57EE071EBA6314DE5F3CC7928ADD767DB215E364EA22F66979C5C76DF6F41BFDE186CCC096BB1AB5B1E74631F951FA3D71EDFA18B74",
                        "Ra1": "0xB9DF28D524BBE5055D2EF4E63119EC8B424EDEED8DAEAC14E9958AC796A43C2A9E122BCAB9FA33A52AB67D627884244BF2377415EA1F7BB6863546991685BE4660B72BB91F1688B7A5EECA19A3D06FB4D06935E13DCAFD69604B05C608E7CBB457DB3FE953465AC2FF031151D1FE34BE7AD1FE8F9A5419C266E289E5E01240A45E3B27BEB75563B3BA291EA9F0D07F6BC56E0A20C67614C4D44BA0C5DDD05F3C2828053775D47AE3BEC2F741FE0CA77AEAE646D805F6327855EFE92759BB689C99766A857FAA2EAA66838654DB607F3B466F00DC935D043F8AD61A5AB90E9CE541EB65A15150EEF9D6625F12CDB33A4BF52BA6014F3BB195F9C8611AA9AE2B73",
                        "Ra2": "0x9CE46938AF0B010A0ACF0AD8E7DC0FF14754A3E4C08CEB57219450A1E9E6D57E2000106A7BF8C46FEBC1B5F45A04AF2E14FBC5FFAAF049D63D5433A7253FB88885FA004C2FD3BD3D3EF46697978F1A5F5C5210146EADE593D3004FBCAD9B2401E4A16A89B69B775F7B3A34AD96C3202276F441F1E1599BB4A31BAAB3F8FA9605EB08AFB9A5B1448981C86D64F3B2C39C8A994D117A07B5E6AEAD5346AD5416962FFD330187EF1641E064F22D052548785EA4339AF395AAADC1BE88CA0DC394AB545FBEC1EDA8EA9899125C1B1256298353A189FA0272026B26729408D605CFA08C6D5CAB59F3C7A397436DE6C0D3435AF18C06C50742CA2D2DF895CFF2111E16",
                        "Ra3": "0x2B151D790BC847EA30F4F988F19908BF487D3C272ED817B6BA222EF35B7EBE1200ECDA57C512FDBBDF702BFD23F925CDAD9E740CD9E5FB4DCA2102508C522484B1C6BD48884CCFC8E7951241DEEE76CA6D5DFCD4097A9FA5F3C65EA148F30B5A469330DB0A71A7E624D02056BFFA110A38D0AFBDEF61A469772F1D216D245FF6F14BC430ECA089AFD864B2A27E840E2591D3D64FE31905BAB0BD0475702ADA9208F1A1A4A0003307D281EA1C826713A41C02EBD58B277999AE4B28CA0E9AD14904D234FFAF38B5584FBD5571562DC6ED1F1F3185224B21CE0C3449DF370D8AF4D708099CF117EE15AC8E9743B6602C97076737FAEAFF3B0258DC9163715A7EA99",
                        "Ra4": "0x774822032480EBE968D865690AC80958A09AE2E470C5A72DC1B3C0D8C9F53409BCAD45FD490256729D6AEE78A31FFFB28AB4DABA61AAFDE6607FC93A628B13402F77D6CA8AD07520C7D438B56EA38DB044EEFF364D6C614CFA79503A7CFF93E202C1EF6F92895FE8EB3D8A1E359C5C35C2770B8521F1D0F6E312F3332BB9E2F79C7A3036324A22F34A400783CA3EF5F0C1F40A2DC888F193A52BE6BCADC11A6D7E2A836237ADEC50AEFAD567BD1C0BFF29B301FC5391A8035FDC2E2A937D622416B0612E7E8202AE66C9B012517D01A5D7DD58B39F420FF6F0B5DCE8330473F1B7FCFAB27B709D2B29BEAEAEE9E8B0B9BBE3DF92EE95901EB27760CEC0783D86",
                        "Ra5": "653EED5856461ABFAD56288DC0D00B32648A31F6FDE8073D324AEC7E7FCDB04C6C007451998BDB5BE4C51EC43498646C7CC70E7696E8D25704707E26B12F540D75AA78CDC3FC8F2A279D472DDEA549D3ACB599C1667838E06934458F1B1110E3561425C02A4BFCDC3B88D8601434F00E9C1E7EF0EE6B8E517429343A3E158B43C66047EEA0C96AC15A1B00BA5D95D2006135B40C08D79901A58645840F39E93F7C10FB08FF1FA873998752A99504BF1E4E17B285ECC26A085FAE5AE45F67CA695D876BD74137C8E60B9F3C4BFB8E5B8790B7B04289DF8D28EF6195A2649D4FC1401AF083E460A1857E629779346A1095F0001071AF381F350E06DA13CB85E192",
                        "Ra6": "0x290EE03805B0F53CBCD58B52F0516718105A3ECA5A9769239F496AFA297D2108715AE72E37617EDF4361627A45F26DC12384E3B9AEC4586C142E0CCE98BBB03E22C19A4E599B6559952BF8C5FBD648A0AA6AF0FD6E367CEBB07C6305267C24F4FD29F7E280CB5A0DA79ABF31FA6D3BB399767EE558F117CFBF8942FE9139EFCDC4E97610C9D262E9F933EA978EE8EF36E8F1EC474E63C18CC5A26DD798B28479E773C29B6FB700F822F95C3113A675A98235661066A3072144846D4F2F7277F09385F9D1710815F38EA78BF1D310D2651879FF2CE77730350AB2F8786CCC45128C24D79F7ED17E3043CD05FAB44A448781FF64753E7ADE07B73A6911ED831B34A",
                        "Ra7": "0xDFC4058D76C7BD759BFEB16F2DA8AC99DBA9BCE3AD4DFF38ACD58059636FA8531B88A5D390BE4FB39D67BC1BE34085D420C08909FAA21CEB5F745334F4B2B8CBF79170BB804A56A333E077C464068549A1F4E81F3348DDEFA33E2E4B8F7C453FDB8046BF2EFD2E3D437B0828F156BED9E3487E7705C67448260F44D925DCC0337D7F48BEE7C9FC2CA7E479241CB74C95F75393F7BC2CE9D7C104004212B5C82AD94B681C3A094CB769C3D15C4F54DBFA2C70AD574870B46FD27E4155FD8561C52B375961E4878EE3B1752D3629C94292597B8A351221E6CEA42F277B7EB0E759EB47F0FC8F041C4470D07EC78D21697DFA7B48241F3B61221E8576775F5E94FB",
                        "Ra8": "0x22F7B5B9C9C9E855F5BDEFFE414EEBB162DC439D304C3B65C09F3846FE8025961626C3D030397A1810EA968C44A4A6FD4D8150B530BC477B12E35D024937668698275CF3ACB89DD4166F35B393D03BDFC0A898A21EE2917C437C31B2EAAA7E056D5D6A4E73D88BC2B6CBAA53BBE428317D299DD4C58A18E296F66D7A24B8BC78E7CE3ACD6D462F388A320356DE3ECF28DE88F10E28EE8892A4D05EB9A3AA9ABDE1CDB48076634A6DB5C1966F5FD99F9C9984302329FDC5034D468DE69B967D7C93BF242DECF80AC4903166CFA31D629C9E2B27BA2E244A7282423A7BC5472753A3FD6B0EF5F283534CC168F3B1FA5365CF6A3263692CA254C8565C2688A2F918A",
                        "Ra9": "0x20433AD6C1D613BE63785D38BB4E65CD57DCF4F4736E7B827790AB3F7315AF5BA4DDCDDD86003718F9F21F4BF7BC4BBF3D0819EC579026CE106AD1A44E30BE8B1C411C1FFC2E3BC1841C3768A4C876965EB52E5E067679869D8EF7B33E6EAFF209ADE2A07A2F993C540400EE02B75AF7E799362293A7E7A1E99666E257AB464E88678D49DA8E06BFDA8F9AF6B8F80158B025846651F0F6228E09FC0217550999D1047D96A25F65358497A1CAD72FAF77A95152D518082530DD8138AE16778F8D51A2F424D062EB113ABAF29EE257C7468E6D22B5A0ACFE3811CD191001D6821FF6AE5DB92F272A462F5C99A0A88CC431851C69D40C8D2293C7634D2B15943466F",
                        "Ra10": "0x165420583BF18E090C389C2388A0C5320F2E0507ABF411A032FC73F1BD63836578AFFC4BE045C4A64468EAFB6C0C803DEEB7A28A199C8A2F5BE594B213664C3684D5C6D1502B52BB87EC39A96EF10812904963BAF8BF37433C5355B72C0D262ADFDB1001BF8D9EDB964AEB4E5DB76ADED70B2105FDBECD911E06DC4084B4986BE948B8943BDA68398A93D9BBE39201F5C96F3E69A688131F74E641AC290011921341AEB1FA8F80F4842A3BE43168ADE30E8538D9C3B97548BC770D32786A6029C1C8148D2090FCB49E1A95C483BEB52955AA96723E3837492FD11213E37E2B0C0EBB79F339BF2BA25F8F502C9D1FEBF54B752488D38EFAB870F5410A4A4C4E75C"
                    }
                },
                RS_CRED_DEF_TAG: 'your it!'
            }
        },
        "identifier": authors_did,
        "reqId": 1565971763281198952,
        "protocolVersion": 2
    })
    req = sdk_sign_and_submit_req(sdk_pool_handle, sdk_wallet_endorser, txn_json)
    rep = sdk_get_and_check_replies(looper, [req])
    assert rep[0][1]['result']['txnMetadata']['txnId']
